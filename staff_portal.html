<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Docu-Hub Master Portal | Internal Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --navy: #003366; --gold: #D4AF37; --parchment: #F5F0EC; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--navy); color: white; margin: 0; padding: 0; }
        .serif { font-family: 'Playfair Display', serif; }
        
        /* Layout */
        .app-container { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .sidebar { width: 100%; height: auto; border-top: 1px solid rgba(255,255,255,0.1); order: 2; flex-direction: row; background: #002855; flex-shrink: 0; }
        .sidebar-nav { flex-direction: row; justify-content: space-around; width: 100%; padding: 8px; gap: 0; }
        .sidebar-link { flex-direction: column; gap: 4px; padding: 8px; font-size: 10px; text-align: center; flex: 1; opacity: 0.6; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sidebar-link.active { background: var(--gold); color: var(--navy); opacity: 1; font-weight: 600; border-radius: 4px; }
        .sidebar-header, .sidebar-footer { display: none; }
        .main-content { flex: 1; order: 1; overflow-y: auto; background-color: var(--parchment); color: var(--navy); padding: 16px; position: relative; }
        
        /* Cards */
        .dashboard-card { background: white; color: var(--navy); border-radius: 4px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 4px solid var(--navy); }
        
        /* SOP Specific Styles */
        .sop-card { background: white; border-radius: 4px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 4px solid var(--navy); transition: all 0.2s; color: var(--navy); }
        .sop-card:hover { transform: translateY(-2px); border-left-color: var(--gold); }
        .agency-label { font-size: 10px; font-weight: 800; letter-spacing: 0.1em; color: var(--gold); margin-bottom: 4px; display: block; text-transform: uppercase; }

        /* Table Styles */
        .audit-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .audit-table th { text-align: left; padding: 12px; background: #f3f4f6; color: #6b7280; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #e5e7eb; }
        .audit-table td { padding: 12px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .status-badge { padding: 4px 8px; border-radius: 99px; font-weight: 700; text-transform: uppercase; font-size: 9px; display: inline-block; }
        
        .status-PENDING { background: #fee2e2; color: #991b1b; } /* Red */
        .status-CLEARED { background: #dcfce7; color: #166534; } /* Green */
        .status-New { background: #fef3c7; color: #92400e; }    /* Yellow */
        
        @media (min-width: 768px) {
            .app-container { flex-direction: row; }
            .sidebar { width: 18rem; height: 100vh; order: 1; border-top: none; border-right: 1px solid rgba(255,255,255,0.1); flex-direction: column; }
            .sidebar-nav { flex-direction: column; padding: 1rem; gap: 0.5rem; justify-content: flex-start; }
            .sidebar-link { flex-direction: row; gap: 12px; padding: 12px; font-size: 14px; text-align: left; opacity: 0.7; }
            .sidebar-header, .sidebar-footer { display: block; }
            .main-content { padding: 2.5rem; }
        }

        .hidden { display: none !important; }
        input, select { color: var(--navy) !important; background-color: #ffffff !important; border: 2px solid #e5e7eb !important; border-radius: 4px !important; font-size: 16px !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--navy); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-overlay" class="fixed inset-0 bg-[#003366] z-[999] flex items-center justify-center p-6 text-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full border-t-8 border-gold">
            <h1 class="serif text-3xl font-bold mb-2 text-gold">DOCU-HUB</h1>
            <p class="text-[10px] uppercase tracking-widest mb-6 opacity-60 font-bold text-navy">Internal Operations</p>
            <div class="space-y-4 text-left">
                <label class="text-[9px] font-bold uppercase text-gray-400 ml-1">Staff Access PIN</label>
                <input type="password" id="staff-pin" inputmode="numeric" placeholder="••••••" 
                       class="w-full p-4 rounded text-center tracking-[1em] text-xl font-bold outline-none focus:border-gold">
                <button type="button" onclick="validateAccess()" 
                        class="w-full bg-[#003366] text-white py-4 font-bold uppercase tracking-widest rounded shadow-lg active:scale-95 transition-all hover:bg-gold hover:text-navy">
                    Unlock System
                </button>
            </div>
            <p id="login-error" class="text-red-600 text-[10px] mt-4 hidden font-bold">INVALID PIN PROVIDED</p>
        </div>
    </div>

    <div id="main-app" class="app-container hidden">
        <aside class="sidebar flex">
            <div class="sidebar-header p-8 text-center">
                <h1 class="serif text-2xl font-bold tracking-widest text-gold">DOCU-HUB</h1>
                <p class="text-[9px] opacity-50 uppercase tracking-widest mt-1 text-white">Liaison Services</p>
            </div>
            <nav class="sidebar-nav flex">
                <div class="sidebar-link active" onclick="switchView('dashboard', this)"><i data-lucide="layout-dashboard"></i> <span>Live Audit</span></div>
                <div class="sidebar-link" onclick="switchView('intake', this)"><i data-lucide="file-plus-2"></i> <span>Walk-In</span></div>
                
                <!-- COMBINED: Now calls switchView instead of window.open -->
                <div class="sidebar-link" onclick="switchView('protocols', this)"><i data-lucide="book-open-check"></i> <span>Protocols</span></div>

                <div class="sidebar-link" onclick="switchView('settings', this)"><i data-lucide="settings"></i> <span>Admin</span></div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6">
                <div>
                    <h2 class="serif text-2xl md:text-3xl font-bold text-navy uppercase" id="page-title">Live Audit</h2>
                    <p class="text-[10px] md:text-sm text-gray-500 font-medium italic" id="last-updated">Syncing...</p>
                </div>
                <div class="w-full md:w-auto bg-white px-4 py-2 rounded shadow-md border-l-4 border-gold flex items-center justify-between gap-4">
                    <div class="text-right">
                        <p class="text-[8px] uppercase text-gray-400 font-bold tracking-widest leading-none mb-1">Active Cases</p>
                        <span class="text-xl font-extrabold text-navy block uppercase" id="active-count">0</span>
                    </div>
                    <i data-lucide="activity" class="w-4 h-4 text-gold"></i>
                </div>
            </header>

            <!-- VIEW: LIVE AUDIT DASHBOARD -->
            <div id="view-dashboard" class="view-section space-y-4">
                <div class="dashboard-card border-t-8 border-navy p-0 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="serif text-lg font-bold italic text-navy">Master Intake Register</h3>
                        <button onclick="loadIntakeData()" class="text-[10px] uppercase font-bold text-gray-400 hover:text-navy flex items-center gap-1">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Refresh Data
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="audit-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Service</th>
                                    <th>Client</th>
                                    <th>Funds</th> <!-- Col F -->
                                    <th>Status</th> <!-- Col G -->
                                    <th>Evidence</th> <!-- Col E -->
                                </tr>
                            </thead>
                            <tbody id="audit-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="6" class="p-8 text-center text-gray-400">Connecting to Secure Vault...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: WALK-IN INTAKE -->
            <div id="view-intake" class="view-section hidden">
                <div class="dashboard-card border-t-8 border-gold max-w-4xl">
                    <h3 class="serif text-xl md:text-2xl font-bold mb-6">Manual Case Enrollment</h3>
                    <p class="text-xs text-gray-400 mb-4">Use this form for walk-ins. Data will be pushed to the Master Sheet.</p>
                    <form class="space-y-6">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" placeholder="Full Legal Name" class="w-full p-4 outline-none">
                            <input type="text" placeholder="Service Type" class="w-full p-4 outline-none">
                        </div>
                        <button type="button" class="w-full bg-[#003366] text-white py-4 font-bold uppercase text-xs rounded shadow-lg">Commit to Ledger</button>
                    </form>
                </div>
            </div>

            <!-- VIEW: PROTOCOLS (SOP Library) -->
            <div id="view-protocols" class="view-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="serif text-xl font-bold text-navy">Standard Operating Procedures</h3>
                        <p class="text-xs text-gray-500 uppercase tracking-widest mt-1">Authorized Protocol Library</p>
                    </div>
                    <button onclick="loadProtocols()" class="text-xs font-bold text-gold uppercase tracking-widest hover:text-navy flex items-center gap-2">
                        <i data-lucide="rotate-cw" class="w-4 h-4"></i> Refresh
                    </button>
                </div>

                <div id="sop-loading" class="text-center py-20 opacity-50 hidden">
                    <div class="loader mb-4"></div>
                    <p class="text-sm font-bold uppercase tracking-widest">Fetching Manuals...</p>
                </div>

                <div id="sop-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Dynamic SOP Cards will appear here -->
                </div>
            </div>

            <div id="view-settings" class="view-section hidden">
                 <div class="dashboard-card"><p>Admin Settings</p></div>
            </div>

        </main>
    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydSBaVXXnRo1GhmJ9SfPDWTwa2N6muR5tWfQRLrtsUVr-XA3P9uXqH7eFrS0anlIO-/exec"; 

        // 1. DATA LOADER (Dashboard)
        async function loadIntakeData() {
            const tableBody = document.getElementById('audit-table-body');
            const countDisplay = document.getElementById('active-count');
            const timeDisplay = document.getElementById('last-updated');

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get_log`);
                const data = await response.json();

                if (!data || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center">No active records found in the Ledger.</td></tr>';
                    countDisplay.textContent = '0';
                    return;
                }

                countDisplay.textContent = data.length;
                timeDisplay.textContent = "Synced: " + new Date().toLocaleTimeString();

                tableBody.innerHTML = data.map(row => {
                    const dateObj = new Date(row.timestamp);
                    const dateStr = !isNaN(dateObj) ? dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' }) : row.timestamp;
                    
                    let fundsClass = 'bg-gray-100 text-gray-500';
                    if (row.funds && row.funds.toUpperCase() === 'CLEARED') fundsClass = 'status-CLEARED';
                    if (row.funds && row.funds.toUpperCase() === 'PENDING') fundsClass = 'status-PENDING';

                    const linkHtml = row.link ? 
                        `<a href="${row.link}" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold underline text-[10px]">VIEW FILES</a>` : 
                        `<span class="text-gray-300 text-[10px]">NO FILES</span>`;

                    return `
                        <tr class="hover:bg-blue-50 transition">
                            <td class="font-mono text-xs text-gray-500">${dateStr}</td>
                            <td class="font-bold text-navy">${row.service}</td>
                            <td class="text-gray-700">${row.client}</td>
                            <td><span class="status-badge ${fundsClass}">${row.funds || 'PENDING'}</span></td>
                            <td><span class="status-badge bg-gray-100 text-navy">${row.status || 'New Intake'}</span></td>
                            <td>${linkHtml}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error(error);
                tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500 font-bold">Connection Error.</td></tr>';
            }
        }

        // 2. PROTOCOL LOADER (SOPs)
        async function loadProtocols() {
            const grid = document.getElementById('sop-grid');
            const loader = document.getElementById('sop-loading');
            
            grid.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                // Fetch from same script, default action gets files
                const response = await fetch(SCRIPT_URL);
                const files = await response.json();

                loader.classList.add('hidden');

                if (files.status === 'error') throw new Error(files.message);
                if (files.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center text-gray-400 italic">No SOP documents found.</div>`;
                    return;
                }

                grid.innerHTML = files.map(file => {
                    let category = "GENERAL PROTOCOL";
                    let icon = "file-text";
                    
                    const name = file.name.toUpperCase();
                    if (name.includes("PICA")) { category = "PICA / PASSPORT"; icon = "passport"; }
                    else if (name.includes("RGD")) { category = "RGD / VITAL RECORDS"; icon = "scroll"; }
                    else if (name.includes("TAJ") || name.includes("TAX")) { category = "TAJ / REVENUE"; icon = "truck"; }
                    else if (name.includes("JCF") || name.includes("POLICE")) { category = "JCF / SECURITY"; icon = "shield"; }
                    else if (name.includes("NIS")) { category = "NIS / SOCIAL"; icon = "users"; }

                    return `
                    <div class="sop-card flex flex-col justify-between h-full">
                        <div>
                            <span class="agency-label">${category}</span>
                            <h3 class="serif font-bold text-lg leading-tight mb-2">${file.name.replace('.pdf', '')}</h3>
                            <p class="text-[10px] text-gray-400 mb-6 uppercase tracking-wider">PDF Document</p>
                        </div>
                        <a href="${file.url}" target="_blank" class="w-full bg-[#f3f4f6] hover:bg-[#003366] hover:text-white text-[#003366] py-3 px-4 rounded text-xs font-bold uppercase tracking-widest transition flex items-center justify-center gap-2 group">
                            <span>Open Document</span>
                            <i data-lucide="${icon}" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                        </a>
                    </div>
                    `;
                }).join('');
                
                lucide.createIcons(); // Refresh icons for new content

            } catch (error) {
                console.error(error);
                loader.classList.add('hidden');
                grid.innerHTML = `<div class="col-span-full p-8 text-red-600 text-center">Error loading protocols. Check network or permissions.</div>`;
            }
        }

        // 3. AUTHENTICATION LOGIC
        function validateAccess() {
            const input = document.getElementById('staff-pin').value;
            if (input === '120470') {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                sessionStorage.setItem('docuhub_staff_auth', 'true');
                loadIntakeData(); 
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('staff-pin').value = '';
            }
        }

        if (sessionStorage.getItem('docuhub_staff_auth') === 'true') {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            loadIntakeData();
        }

        document.getElementById('staff-pin').addEventListener('keypress', (e) => { if (e.key === 'Enter') validateAccess(); });

        // 4. VIEW SWITCHER
        function switchView(viewName, element) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            const titles = { 'dashboard': 'DASHBOARD', 'intake': 'INTAKE', 'protocols': 'PROTOCOLS', 'settings': 'ADMIN' };
            document.getElementById('page-title').textContent = titles[viewName];
            
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            if(element) element.classList.add('active');
            
            if(viewName === 'dashboard') loadIntakeData();
            if(viewName === 'protocols') loadProtocols(); // Auto-load SOPs when tab is clicked
        }
    </script>
</body>
</html>
