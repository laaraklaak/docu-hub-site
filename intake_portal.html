<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Intake | Docu-Hub Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,700;1,600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --navy: #003366; --parchment: #F5F0EC; --gold: #D4AF37; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--parchment); color: var(--navy); }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .bg-navy { background-color: var(--navy); }
        .text-navy { color: var(--navy); }
        .border-gold { border-color: var(--gold); }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid var(--gold);
            border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .disabled-input { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Simple Header -->
    <nav class="bg-navy text-white p-6 shadow-md">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="shield-check" class="text-gold w-6 h-6"></i>
                <div>
                    <span class="block text-sm font-bold tracking-widest uppercase">Docu-Hub</span>
                    <span class="block text-[10px] text-gold uppercase tracking-[0.2em]">Secure Intake Node</span>
                </div>
            </div>
            <a href="index.html" class="text-xs uppercase font-bold text-gray-400 hover:text-white transition">Exit</a>
        </div>
    </nav>

    <!-- Main Form Area -->
    <main class="flex-grow p-6">
        <div class="max-w-2xl mx-auto bg-white p-8 md:p-12 shadow-2xl border-t-4 border-gold rounded-sm">
            
            <div class="text-center mb-10">
                <h1 class="text-3xl font-bold mb-2">Client Digital Intake</h1>
                <p class="text-sm text-gray-500">Your documents are encrypted and sent directly to our secure vault.</p>
            </div>

            <form id="intakeForm" class="space-y-6" onsubmit="handleFormSubmit(event)">
                
                <!-- Section 1: Identity -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-gold uppercase tracking-widest border-b border-gray-100 pb-2">01. Identity Validation</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-navy mb-1">Full Name</label>
                            <input type="text" name="lastName" required class="w-full bg-gray-50 border border-gray-200 p-3 rounded-sm text-sm focus:border-gold outline-none" placeholder="e.g. John Brown">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-navy mb-1 flex justify-between">
                                <span>TRN (9 Digits)</span>
                            </label>
                            <input type="text" id="trnInput" name="trn" required maxlength="9" pattern="\d{9}" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-sm text-sm focus:border-gold outline-none" placeholder="e.g. 123456789">
                            
                            <!-- New Application Toggle -->
                            <div class="flex items-center gap-2 mt-2">
                                <input type="checkbox" id="newAppCheck" class="accent-[#D4AF37] w-4 h-4 cursor-pointer">
                                <label for="newAppCheck" class="text-[10px] font-bold text-gray-500 cursor-pointer uppercase tracking-wider hover:text-navy">I am applying for a new TRN</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Service Context -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-gold uppercase tracking-widest border-b border-gray-100 pb-2">02. Service Context</h3>
                    
                    <div>
                        <label class="block text-xs font-bold text-navy mb-1">Service Required</label>
                        <select id="serviceSelect" name="service" required class="w-full bg-gray-50 border border-gray-200 p-3 rounded-sm text-sm focus:border-gold outline-none">
                            <option value="" disabled selected>Select Service...</option>
                            <option value="RGD Suite">RGD Suite (Vital Records)</option>
                            <option value="PICA Passport">PICA Suite (Passports)</option>
                            <option value="TAJ Compliance">TAJ Suite (Vehicle & Tax)</option>
                            <option value="NIS Registration">NIS Registration</option>
                            <option value="Police Record">Police Record Application</option>
                            <option value="General Inquiry">Other / General Inquiry</option>
                        </select>
                    </div>
                    <input type="hidden" name="location" value="local">
                </div>

                <!-- Section 3: Document Upload -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-gold uppercase tracking-widest border-b border-gray-100 pb-2">03. Secure Upload</h3>
                    
                    <div class="border-2 border-dashed border-gray-200 bg-gray-50 rounded-lg p-8 text-center hover:border-gold transition-colors relative">
                        <input type="file" id="fileInput" multiple required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-300 mx-auto mb-2"></i>
                        <p class="text-sm font-bold text-navy">Tap to Select Files</p>
                        <p class="text-xs text-gray-400">PDF, JPG, or PNG (Max 5MB)</p>
                        <div id="fileList" class="mt-4 text-xs text-left space-y-1 text-gold font-bold"></div>
                    </div>
                </div>

                <!-- Section 4: Compliance Gate -->
                <div class="bg-navy/5 p-4 rounded border border-navy/10">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" name="consent" required class="mt-1">
                        <span class="text-xs text-gray-600 leading-relaxed">
                            <strong>Compliance Consent:</strong> I authorize Docu-Hub Operations Services to process these documents for the purpose of government liaison. I understand this data will be handled according to the JDPA/POCA protocols.
                        </span>
                    </label>
                </div>

                <!-- Submit Area -->
                <button type="submit" id="submitBtn" class="w-full bg-navy text-white py-4 rounded-sm font-bold uppercase tracking-widest hover:bg-gold hover:text-navy transition-all shadow-lg flex justify-center items-center gap-3">
                    <span>Initialize Secure Transfer</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>

            </form>

            <!-- Success Message -->
            <div id="successMessage" class="hidden text-center py-10">
                <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="check" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-navy mb-2">Transmission Complete</h2>
                <p class="text-sm text-gray-500 mb-8">Your documents have been securely logged in our Vault. An intake officer will verify them shortly.</p>
                <a href="index.html" class="inline-block bg-gold text-white px-8 py-3 rounded-sm text-xs font-bold uppercase tracking-widest hover:bg-navy transition-colors">Return Home</a>
            </div>

        </div>
    </main>

    <script>
        lucide.createIcons();

        // --- 1. CONFIGURATION ---
        // PASTE YOUR DEPLOYED GOOGLE WEB APP URL HERE
        const SCRIPT_URL = "REPLACE_WITH_YOUR_WEB_APP_URL"; 

        // --- 2. AUTO-FILL SERVICE FROM URL ---
        window.addEventListener('DOMContentLoaded', (event) => {
            const params = new URLSearchParams(window.location.search);
            const service = params.get('service');
            if (service) {
                const select = document.getElementById('serviceSelect');
                // Simple mapping to match the option values
                if (service.includes("pica")) select.value = "PICA Passport";
                else if (service.includes("rgd")) select.value = "RGD Suite";
                else if (service.includes("taj")) select.value = "TAJ Compliance";
                else if (service.includes("nis")) select.value = "NIS Registration";
                else if (service.includes("police")) select.value = "Police Record";
            }
        });
        
        // --- 3. NEW TRN TOGGLE LOGIC ---
        document.getElementById('newAppCheck').addEventListener('change', function(e) {
            const input = document.getElementById('trnInput');
            if(this.checked) {
                input.value = "New Application"; 
                input.disabled = true; 
                input.required = false;
                input.classList.add('disabled-input', 'text-gray-500', 'bg-gray-100');
            } else {
                input.value = "";
                input.disabled = false; 
                input.required = true;
                input.classList.remove('disabled-input', 'text-gray-500', 'bg-gray-100');
                input.placeholder = "e.g. 123456789";
                input.focus();
            }
        });

        // --- 4. FILE HANDLING ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            const MAX_SIZE = 5 * 1024 * 1024; // 5MB limit
            
            Array.from(this.files).forEach(file => {
                if (file.size > MAX_SIZE) {
                    alert(`File "${file.name}" is too large (Max 5MB). Please compress it.`);
                    this.value = ""; // Reset input
                    list.innerHTML = "";
                    return;
                }
                list.innerHTML += `<div>â€¢ ${file.name}</div>`;
            });
        });

        // --- 5. FORM SUBMISSION ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const originalBtnContent = btn.innerHTML;
            
            // UI Loading State
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> Processing Encryption...';

            const form = e.target;
            const formData = {
                lastName: form.lastName.value,
                trn: document.getElementById('newAppCheck').checked ? "New Application" : form.trn.value,
                service: form.service.value,
                location: form.location.value,
                consent: form.consent.checked,
                files: []
            };

            const fileInput = document.getElementById('fileInput');
            
            try {
                // Ensure URL is set
                if (SCRIPT_URL.includes("https://script.google.com/macros/s/AKfycbwSqGZQ0txw65IS6A-rV7mNG2yIH4S6cCBKzXAOazRBVQxhucIXQhalMHRdfUyy3f-img/exec")) {
                    throw new Error("System Error: Backend URL not configured.");
                }

                // Process Files (Convert to Base64)
                if (fileInput.files.length > 0) {
                    for (const file of fileInput.files) {
                        const base64 = await getBase64(file);
                        formData.files.push({
                            name: file.name,
                            mimeType: file.type,
                            bytes: base64
                        });
                    }
                }

                // Send to Google Script
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    mode: 'no-cors', // Critical for Apps Script
                    headers: { 'Content-Type': 'application/json' }
                });

                // Show Success
                form.classList.add('hidden');
                document.getElementById('successMessage').classList.remove('hidden');
                window.scrollTo(0, 0);

            } catch (error) {
                console.error('Error:', error);
                alert("Transmission Error: " + error.message);
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
            }
        }

        // Helper: File to Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove the Data-URL prefix (e.g. "data:image/png;base64,")
                    const rawBase64 = reader.result.split(',')[1]; 
                    resolve(rawBase64);
                };
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>
