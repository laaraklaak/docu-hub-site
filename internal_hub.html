<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docu-Hub | Modular Service Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --navy: #003366; --gold: #D4AF37; --parchment: #F5F0EC; --research-gold: #FFD700; --urgency-red: #fee2e2; }
        body { font-family: 'Inter', sans-serif; background-color: var(--parchment); color: var(--navy); }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        
        /* Highlighting Logic for Audit Master */
        .research-gold { background-color: var(--research-gold) !important; color: #000 !important; border-left: 6px solid var(--gold); }
        .warning-red { background-color: #fff1f2 !important; color: #991B1B !important; border-left: 6px solid #dc2626; }
        
        .btn-path { border: 2px solid transparent; transition: all 0.3s; cursor: pointer; }
        .btn-path:hover { border-color: var(--gold); transform: translateY(-2px); }
        .btn-path.active { border-color: var(--navy); background: white; box-shadow: 0 4px 12px rgba(0,51,102,0.1); }
        
        .module-card { background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        
        /* Official Certificate Styling */
        .cert-border { border: 12px double var(--navy); position: relative; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 4rem; opacity: 0.03; pointer-events: none; white-space: nowrap; font-weight: 900; z-index: 0; }
        
        #login-shield { background-image: radial-gradient(circle at center, #004080 0%, #001a33 100%); }

        @media print {
            body * { visibility: hidden; }
            #cert-modal, #cert-modal * { visibility: visible; }
            #cert-modal { position: absolute; left: 0; top: 0; width: 100%; background: white; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen pb-20 overflow-x-hidden">

    <!-- 1. LOGIN SHIELD (JDPA COMPLIANCE GATE) -->
    <div id="login-shield" class="fixed inset-0 z-[100] flex items-center justify-center p-4 transition-opacity duration-500">
        <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden border-t-8 border-[#D4AF37]">
            <div class="p-8 text-center space-y-6">
                <div class="flex justify-center">
                    <div class="w-20 h-20 bg-[#003366] text-[#D4AF37] flex items-center justify-center rounded-full shadow-lg">
                        <i data-lucide="shield-check" size="32"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-[#003366]">Docu-Hub Access</h1>
                    <p class="text-gray-500 text-xs uppercase tracking-widest mt-2 font-semibold">Authorized Personnel Only</p>
                </div>
                <div class="space-y-4">
                    <input type="password" id="agent-pin" placeholder="Enter Access PIN" 
                           class="w-full p-4 border rounded-xl text-center text-2xl tracking-[0.5em] outline-none focus:ring-2 focus:ring-[#003366]">
                    <button onclick="attemptLogin()" class="w-full bg-[#003366] text-white py-4 rounded-xl font-bold hover:bg-black transition shadow-lg uppercase tracking-widest">
                        Unlock Hub
                    </button>
                    <p id="login-error" class="text-red-600 text-[10px] font-bold hidden uppercase">Invalid Credentials. Session Logged.</p>
                </div>
                <p class="text-[10px] text-gray-400">Pursuant to the Jamaican Data Protection Act (JDPA) 2020.</p>
            </div>
        </div>
    </div>

    <!-- 2. MAIN HUB INTERFACE -->
    <div id="app-content" class="hidden opacity-0 transition-opacity duration-700">
        <nav class="bg-[#003366] text-white p-4 sticky top-0 z-50 border-b-2 border-[#D4AF37]">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i data-lucide="layers" class="text-[#D4AF37]"></i>
                    <span class="text-xl font-bold uppercase tracking-widest">Docu-Hub</span>
                </div>

                <!-- SOP LIBRARY CONNECTION -->
                <div class="hidden md:flex flex-1 justify-center">
                    <button onclick="window.open('sop.html', '_blank')" class="flex items-center gap-2 text-[10px] font-bold uppercase tracking-[0.2em] px-6 py-2 border border-[#D4AF37]/30 rounded-full hover:bg-[#D4AF37] hover:text-[#003366] transition-all">
                        <i data-lucide="book-open" size="14"></i>
                        Protocol Library
                    </button>
                </div>

                <div class="flex gap-6 text-xs font-bold uppercase tracking-tighter items-center">
                    <button onclick="showSection('triage')" class="hover:text-[#D4AF37]">Intake Engine</button>
                    <button onclick="showSection('dashboard')" class="hover:text-[#D4AF37]">Audit Master</button>
                    <button onclick="location.reload()" class="text-red-400 hover:text-white border-l border-white/20 pl-6">Exit Hub</button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8 p-4 mt-8">
            <main class="flex-1 space-y-8">
                
                <!-- INTAKE SECTION -->
                <section id="section-triage" class="space-y-8">
                    <header>
                        <h1 class="text-4xl text-[#003366]">Modular Intake Engine</h1>
                        <p class="text-gray-500 text-sm mt-1 uppercase tracking-widest font-semibold">Select Compliance Objective</p>
                    </header>

                    <!-- Service Path Selection -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <button onclick="setPath('A')" id="path-A" class="btn-path module-card text-center">
                            <i data-lucide="user-plus" class="mx-auto mb-2 text-blue-600"></i>
                            <h3 class="text-[10px] font-bold uppercase">Identity</h3>
                        </button>
                        <button onclick="setPath('B')" id="path-B" class="btn-path module-card text-center">
                            <i data-lucide="car" class="mx-auto mb-2 text-yellow-600"></i>
                            <h3 class="text-[10px] font-bold uppercase">Tax/Vehicle</h3>
                        </button>
                        <button onclick="setPath('C')" id="path-C" class="btn-path module-card text-center">
                            <i data-lucide="fingerprint" class="mx-auto mb-2 text-red-600"></i>
                            <h3 class="text-[10px] font-bold uppercase">Police Rec</h3>
                        </button>
                        <button onclick="setPath('D')" id="path-D" class="btn-path module-card text-center">
                            <i data-lucide="briefcase" class="mx-auto mb-2 text-green-600"></i>
                            <h3 class="text-[10px] font-bold uppercase">NIS/Social</h3>
                        </button>
                        <button onclick="setPath('E')" id="path-E" class="btn-path module-card text-center">
                            <i data-lucide="vote" class="mx-auto mb-2 text-purple-600"></i>
                            <h3 class="text-[10px] font-bold uppercase">Elector ID</h3>
                        </button>
                    </div>

                    <!-- Dynamic Workspace -->
                    <div id="workspace" class="hidden">
                        <div id="dynamic-form" class="module-card border-l-8 border-navy"></div>
                    </div>

                    <!-- Compliance Gates -->
                    <div id="universal-gates" class="hidden module-card bg-gray-50 border-2 border-dashed border-gray-300 space-y-6">
                        <h2 class="text-sm font-bold uppercase text-gray-500 flex items-center gap-2">
                            <i data-lucide="shield-check" size="16"></i> Compliance Verification Gates
                        </h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="client-name" placeholder="Full Legal Name" class="p-4 border rounded-lg outline-none focus:ring-2 focus:ring-navy" oninput="validateForm()">
                                <input type="text" id="client-trn" placeholder="TRN (000-000-000)" class="p-4 border rounded-lg outline-none focus:ring-2 focus:ring-navy" oninput="validateForm()">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="flex items-center gap-3 bg-white p-4 rounded-lg border text-[10px] italic text-red-800 font-bold cursor-pointer">
                                    <input type="checkbox" id="check-jdpa" onchange="validateForm()"><span>JDPA CONSENT (STD 1)</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-4 rounded-lg border text-[10px] font-bold text-navy cursor-pointer">
                                    <input type="checkbox" id="check-funds" onchange="validateForm()"><span>FUNDS CLEARED</span>
                                </label>
                            </div>

                            <div class="bg-white p-4 rounded-lg border">
                                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">KYC Binary Upload (Required)</p>
                                <input type="file" id="kyc-file" class="text-xs block w-full" onchange="handleFile(event)">
                            </div>

                            <button id="btn-initialize" disabled onclick="submitToVault()" class="w-full bg-gray-300 text-gray-500 py-4 rounded-xl font-bold transition-all cursor-not-allowed uppercase tracking-widest shadow-lg">
                                Initialize SOP Run
                            </button>
                        </div>
                    </div>
                </section>

                <!-- AUDIT MASTER SECTION -->
                <section id="section-dashboard" class="hidden space-y-6">
                    <div class="flex justify-between items-end">
                        <h1 class="text-3xl text-[#003366]">Audit Master Dashboard</h1>
                        <button onclick="refreshDashboard()" class="text-[10px] font-bold uppercase bg-navy text-white px-4 py-2 rounded-lg hover:bg-black transition flex items-center gap-2">
                            <i data-lucide="refresh-cw" size="12"></i> Manual Sync
                        </button>
                    </div>
                    <div class="module-card !p-0 overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-[#003366] text-white text-[10px] uppercase">
                                <tr>
                                    <th class="p-4">Timestamp</th>
                                    <th class="p-4">Client Detail</th>
                                    <th class="p-4">SOP ID</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-center">Protocol Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="p-10 text-center text-gray-400 italic">Accessing central vault records...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>

            <aside class="w-full lg:w-80 no-print">
                <div class="module-card sticky top-24 border-t-4 border-[#D4AF37] space-y-4">
                    <h2 class="text-xs font-black uppercase tracking-widest text-gray-400 flex items-center gap-2">
                        <i data-lucide="clipboard-check" size="14"></i> SOP Checklist
                    </h2>
                    <div id="sidebar-checks" class="space-y-2 text-[11px] text-gray-600 font-medium italic">
                        Select a path to generate protocol list...
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- 3. SYSTEM NOTIFICATION MODAL -->
    <div id="notify-modal" class="hidden fixed inset-0 bg-black/50 z-[300] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-xs w-full text-center space-y-4 border-t-8 border-navy">
            <div id="notify-icon" class="text-5xl flex justify-center"></div>
            <h3 id="notify-title" class="font-bold text-navy text-xl uppercase tracking-tighter"></h3>
            <p id="notify-msg" class="text-gray-500 text-sm leading-relaxed"></p>
            <button onclick="closeNotify()" class="w-full bg-navy text-white py-3 rounded-lg font-bold uppercase text-xs hover:bg-black transition">Confirm</button>
        </div>
    </div>

    <!-- 4. OFFICIAL CERTIFICATE MODAL -->
    <div id="cert-modal" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
        <div class="max-w-2xl w-full relative">
            <button onclick="closeCert()" class="no-print absolute -top-10 right-0 text-white hover:text-gold flex items-center gap-1 font-bold uppercase text-xs">
                <i data-lucide="x" size="16"></i> Close Registry
            </button>
            <div id="cert-content" class="bg-white p-12 cert-border relative shadow-2xl overflow-hidden text-center">
                <div class="watermark uppercase">Compliance Official</div>
                <div class="relative z-10 space-y-6">
                    <div class="flex justify-center mb-2">
                        <div class="w-16 h-16 bg-navy text-gold flex items-center justify-center rounded-full font-serif text-2xl font-bold shadow-lg">JAM</div>
                    </div>
                    <h1 class="text-4xl font-bold uppercase tracking-[0.1em] text-navy">Certificate of Registry</h1>
                    <p class="text-[10px] font-bold text-gold tracking-[0.4em] uppercase">Docu-Hub Forensic Compliance Division</p>
                    <div class="py-10 border-y border-gray-100 space-y-4">
                        <p class="text-sm italic text-gray-500">Official verification record for subject:</p>
                        <h2 id="cert-client-name" class="text-3xl font-bold underline decoration-gold underline-offset-8 uppercase tracking-tighter">CLIENT NAME</h2>
                        <p class="text-sm">Processed under authority of <span id="cert-sop-id" class="font-bold text-navy">SOP-XXX</span></p>
                        <p class="text-xl font-black uppercase text-navy mt-6 tracking-tighter">Status: Registry Verified</p>
                    </div>
                    <div class="grid grid-cols-2 gap-6 text-left text-[10px] font-bold text-gray-500 uppercase">
                        <div><p class="text-gray-400">Governance</p><p class="text-navy">JDPA 2020 Standard</p></div>
                        <div><p class="text-gray-400">Registry Timestamp</p><p class="text-navy font-mono" id="cert-timestamp">--</p></div>
                    </div>
                    <div class="pt-10 flex justify-between items-end">
                        <button onclick="window.print()" class="no-print px-8 py-2 bg-navy text-white rounded font-bold text-xs hover:bg-black transition uppercase tracking-widest">Print Record</button>
                        <div class="text-right">
                            <div class="w-40 border-b-2 border-navy mb-1"></div>
                            <p class="text-[8px] uppercase font-bold text-navy">Compliance Officer</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SYSTEM CONFIGURATION ---
        const CONFIG = {
            AGENT_PIN: "4012" // Professional PIN Access
        };

        const SERVICE_REGISTRY = {
            'A': { sop: 'SOP-PICA-001', name: 'Identity Restoration', checks: ['Original Birth Cert Sighted', 'Passport Undamaged', 'Witness Signature Verified'] },
            'B': { sop: 'SOP-TAJ-003', name: 'Tax & Vehicle', checks: ['TRN Validated', 'Insurance > 30 Days', 'Fitness Cert Sighted'] },
            'C': { sop: 'SOP-JCF-004', name: 'Police Records', checks: ['Receipt Attached', 'Fingertip Appointment Set', 'Voter ID Bypass: No'] },
            'D': { sop: 'SOP-NIS-005', name: 'NIS Logistics', checks: ['NIS Card Found', 'Employer Stamp Verified'] },
            'E': { sop: 'GOV-JAM-EID-001', name: 'Elector ID', checks: ['EOJ Confirmation Sighted', 'Residence Verified'] }
        };

        let state = { activeSop: null, base64: null, fileName: null };

        // 1. SECURITY LOGIN
        function attemptLogin() {
            const pin = document.getElementById('agent-pin').value;
            const error = document.getElementById('login-error');
            
            if (pin === CONFIG.AGENT_PIN) {
                document.getElementById('login-shield').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-shield').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    setTimeout(() => { 
                        document.getElementById('app-content').classList.remove('opacity-0'); 
                        lucide.createIcons(); 
                    }, 50);
                }, 500);
            } else {
                error.classList.remove('hidden');
                document.getElementById('agent-pin').value = '';
            }
        }

        // 2. FORM INTERACTION
        function setPath(id) {
            state.activeSop = SERVICE_REGISTRY[id];
            
            // UI Switch
            document.querySelectorAll('.btn-path').forEach(b => b.classList.remove('active'));
            document.getElementById(`path-${id}`).classList.add('active');
            
            document.getElementById('workspace').classList.remove('hidden');
            document.getElementById('universal-gates').classList.remove('hidden');
            
            document.getElementById('dynamic-form').innerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-navy">${state.activeSop.name}</h2>
                    <span class="text-[10px] font-black bg-navy text-white px-2 py-1 rounded tracking-tighter">${state.activeSop.sop}</span>
                </div>
                <p class="text-xs text-gray-500 mt-2 font-medium">Internal protocol initialized. Please complete gates below.</p>
            `;

            // Checklist Generation
            const checkHtml = state.activeSop.checks.map(c => `
                <div class="flex items-center gap-2 p-2 border-b border-gray-100 text-[11px]">
                    <i data-lucide="check-circle" size="12" class="text-gold"></i>
                    <span>${c}</span>
                </div>
            `).join('');
            document.getElementById('sidebar-checks').innerHTML = checkHtml;
            lucide.createIcons();
            validateForm();
        }

        function validateForm() {
            const name = document.getElementById('client-name').value;
            const trn = document.getElementById('client-trn').value;
            const jdpa = document.getElementById('check-jdpa').checked;
            const funds = document.getElementById('check-funds').checked;
            const btn = document.getElementById('btn-initialize');

            if (name && trn && jdpa && funds && state.activeSop) {
                btn.disabled = false;
                btn.classList.replace('bg-gray-300', 'bg-navy');
                btn.classList.replace('text-gray-500', 'text-white');
                btn.classList.remove('cursor-not-allowed');
                btn.classList.add('hover:bg-black');
            } else {
                btn.disabled = true;
                btn.classList.replace('bg-navy', 'bg-gray-300');
                btn.classList.replace('text-white', 'text-gray-500');
                btn.classList.add('cursor-not-allowed');
                btn.classList.remove('hover:bg-black');
            }
        }

        // 3. APPS SCRIPT BRIDGE (VAULT CONNECTION)
        function submitToVault() {
            const btn = document.getElementById('btn-initialize');
            btn.innerText = "https://script.google.com/macros/s/AKfycbx6JN7bZpU0S0BYPZaujrN8FjvX_0ERwwPsWstanIyAeQGDvdwnn_W3_8-w_lAwCkpe/exec";
            btn.disabled = true;

            const payload = {
                clientName: document.getElementById('client-name').value,
                trn: document.getElementById('client-trn').value,
                sopId: state.activeSop.sop,
                isGhost: false, // Standard intake
                fileData: state.base64,
                fileName: state.fileName
            };

            // PRODUCTION CONNECTION
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(() => {
                        showNotify('✅', 'SYNC COMPLETE', 'The protocol run has been logged to the central vault.');
                        resetForm();
                        showSection('dashboard');
                        btn.innerText = "Initialize SOP Run";
                    })
                    .withFailureHandler(err => {
                        showNotify('❌', 'SYNC ERROR', 'Protocol sync failed. Error: ' + err);
                        btn.disabled = false;
                        btn.innerText = "Retry Synchronization";
                    })
                    .submitData(payload);
            } else {
                showNotify('ℹ️', 'OFFLINE MODE', 'Environment is not connected to a live Vault. Sync halted.');
                btn.disabled = false;
                btn.innerText = "Initialize SOP Run";
            }
        }

        function refreshDashboard() {
            const tbody = document.getElementById('dashboard-body');
            tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-400 italic animate-pulse">Synchronizing records...</td></tr>';

            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run.withSuccessHandler(data => {
                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-400">Vault Registry is empty.</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.map(row => {
                        const ts = new Date(row[0]).toLocaleString();
                        const client = row[1];
                        const sop = row[3];
                        const status = row[4];
                        
                        let rowClass = "";
                        if (status === 'Ghost') rowClass = "research-gold";
                        if (status === 'Mismatch') rowClass = "warning-red";

                        return `
                            <tr class="${rowClass} hover:bg-gray-50 transition border-b border-gray-100">
                                <td class="p-4 text-[10px] font-mono text-gray-400">${ts}</td>
                                <td class="p-4 font-bold text-xs uppercase tracking-tight">${client}</td>
                                <td class="p-4 text-xs font-semibold text-navy">${sop}</td>
                                <td class="p-4">
                                    <span class="px-2 py-0.5 rounded text-[9px] font-black border bg-white/40 uppercase">
                                        ${status}
                                    </span>
                                </td>
                                <td class="p-4 text-center">
                                    <button onclick="openCert('${client}', '${sop}', '${ts}')" class="bg-navy text-white px-4 py-1.5 rounded text-[10px] font-bold hover:bg-black uppercase tracking-tighter">
                                        Verify Registry
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }).getAuditLogs();
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Audit Master requires a Live Vault connection.</td></tr>';
            }
        }

        // --- HELPERS & MODAL CONTROL ---
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            state.fileName = file.name;
            const reader = new FileReader();
            reader.onload = (evt) => { state.base64 = evt.target.result; };
            reader.readAsDataURL(file);
        }

        function resetForm() {
            document.getElementById('client-name').value = '';
            document.getElementById('client-trn').value = '';
            document.getElementById('check-jdpa').checked = false;
            document.getElementById('check-funds').checked = false;
            document.getElementById('kyc-file').value = '';
            state.base64 = null;
            validateForm();
        }

        function showSection(id) {
            document.getElementById('section-triage').classList.toggle('hidden', id !== 'triage');
            document.getElementById('section-dashboard').classList.toggle('hidden', id !== 'dashboard');
            if (id === 'dashboard') refreshDashboard();
        }

        function openCert(name, sop, date) {
            document.getElementById('cert-client-name').innerText = name;
            document.getElementById('cert-sop-id').innerText = sop;
            document.getElementById('cert-timestamp').innerText = date;
            document.getElementById('cert-modal').classList.remove('hidden');
        }

        function closeCert() { document.getElementById('cert-modal').classList.add('hidden'); }

        function showNotify(icon, title, msg) {
            document.getElementById('notify-icon').innerText = icon;
            document.getElementById('notify-title').innerText = title;
            document.getElementById('notify-msg').innerText = msg;
            document.getElementById('notify-modal').classList.remove('hidden');
        }

        function closeNotify() { document.getElementById('notify-modal').classList.add('hidden'); }

        // ENTER KEY LOGIN
        document.getElementById('agent-pin').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        lucide.createIcons();
    </script>
</body>
</html>


