<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docu-Hub | SOP Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --navy: #003366; --gold: #D4AF37; --parchment: #F5F0EC; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--parchment); color: var(--navy); }
        .serif { font-family: 'Playfair Display', serif; }
        .sop-card { background: white; border-radius: 4px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 4px solid var(--navy); transition: all 0.2s; }
        .sop-card:hover { transform: translateY(-2px); border-left-color: var(--gold); }
        .agency-label { font-size: 10px; font-weight: 800; letter-spacing: 0.1em; color: var(--gold); margin-bottom: 4px; display: block; text-transform: uppercase; }
        .back-btn { background: var(--navy); color: white; padding: 10px 20px; border-radius: 4px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: var(--gold); color: var(--navy); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--navy); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 md:p-12 pb-24">

    <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
        <div>
            <a href="staff-portal.html" class="back-btn text-xs mb-6">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Return to Dashboard
            </a>
            <h1 class="serif text-3xl md:text-4xl font-bold">Protocol Library</h1>
            <p class="text-xs text-gray-500 uppercase tracking-widest mt-2 flex items-center gap-2">
                <span id="status-indicator" class="w-2 h-2 rounded-full bg-yellow-400"></span>
                <span id="status-text">Connecting to Secure Drive...</span>
            </p>
        </div>
        <div class="hidden md:flex items-center justify-center w-16 h-16 bg-white rounded-full border-2 border-gold shadow-lg">
            <i data-lucide="book-open" class="w-8 h-8 text-navy"></i>
        </div>
    </header>

    <!-- Content Area -->
    <div id="library-content" class="space-y-12 max-w-6xl mx-auto">
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-20 opacity-50">
            <div class="loader mb-4"></div>
            <p class="text-sm font-bold uppercase tracking-widest">Fetching Manuals...</p>
        </div>

        <!-- Dynamic Sections will be injected here -->
        <div id="dynamic-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURATION ---
        // Using the same script URL as your Intake form
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydSBaVXXnRo1GhmJ9SfPDWTwa2N6muR5tWfQRLrtsUVr-XA3P9uXqH7eFrS0anlIO-/exec"; 

        async function loadLibrary() {
            const grid = document.getElementById('dynamic-grid');
            const loader = document.getElementById('loading-state');
            const statusText = document.getElementById('status-text');
            const statusInd = document.getElementById('status-indicator');

            try {
                // Fetch data from Google Script (Default GET action returns files)
                const response = await fetch(SCRIPT_URL);
                const files = await response.json();

                if (files.status === 'error') throw new Error(files.message);

                loader.classList.add('hidden');
                grid.classList.remove('hidden');
                statusText.innerText = "Secure Connection Active";
                statusInd.classList.replace('bg-yellow-400', 'bg-green-500');

                // Render Files
                if (files.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center text-gray-400 italic">No SOP documents found in the Drive Folder.</div>`;
                    return;
                }

                // Sort and categorize visually
                grid.innerHTML = files.map(file => {
                    let category = "GENERAL PROTOCOL";
                    let icon = "file-text";
                    
                    // Auto-Categorization based on filename
                    const name = file.name.toUpperCase();
                    if (name.includes("PICA")) { category = "PICA / PASSPORT"; icon = "passport"; }
                    else if (name.includes("RGD")) { category = "RGD / VITAL RECORDS"; icon = "scroll"; }
                    else if (name.includes("TAJ") || name.includes("TAX")) { category = "TAJ / REVENUE"; icon = "truck"; }
                    else if (name.includes("JCF") || name.includes("POLICE")) { category = "JCF / SECURITY"; icon = "shield"; }
                    else if (name.includes("NIS")) { category = "NIS / SOCIAL"; icon = "users"; }

                    return `
                    <div class="sop-card flex flex-col justify-between h-full">
                        <div>
                            <span class="agency-label">${category}</span>
                            <h3 class="serif font-bold text-lg leading-tight mb-2">${file.name.replace('.pdf', '')}</h3>
                            <p class="text-[10px] text-gray-400 mb-6 uppercase tracking-wider">PDF Document</p>
                        </div>
                        <a href="${file.url}" target="_blank" class="w-full bg-[#f3f4f6] hover:bg-[#003366] hover:text-white text-[#003366] py-3 px-4 rounded text-xs font-bold uppercase tracking-widest transition flex items-center justify-center gap-2 group">
                            <span>Open Document</span>
                            <i data-lucide="${icon}" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                        </a>
                    </div>
                    `;
                }).join('');

                lucide.createIcons(); // Re-run for dynamic content

            } catch (error) {
                console.error(error);
                loader.classList.add('hidden');
                statusText.innerText = "Connection Failed";
                statusInd.classList.replace('bg-yellow-400', 'bg-red-500');
                grid.classList.remove('hidden');
                grid.innerHTML = `<div class="col-span-full p-8 bg-red-50 text-red-600 border border-red-200 rounded text-center">
                    <strong>Error Loading Library:</strong> ${error.message}<br>
                    <span class="text-xs">Ensure your 'SOP_FOLDER_ID' is correct in the Apps Script.</span>
                </div>`;
            }
        }

        // Initialize on load
        window.onload = loadLibrary;
    </script>
</body>
</html>
