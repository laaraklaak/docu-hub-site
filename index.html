<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docu-Hub Connector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .research-gold { background-color: #FFD700 !important; color: #000 !important; }
        .warning-red { background-color: #FEE2E2 !important; color: #991B1B !important; border-left: 4px solid #EF4444; }
        .doi-section { border-left: 4px solid #065F46; background-color: #ECFDF5; }
        
        /* Certificate Styling */
        .cert-border { border: 10px double #1e293b; }
        .watermark { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%) rotate(-45deg); 
            font-size: 5rem; opacity: 0.05; pointer-events: none; 
            white-space: nowrap; font-weight: 900;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- Main Form Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <header class="mb-8 border-b pb-4 flex justify-between items-end">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Docu-Hub Connector</h1>
                    <p class="text-slate-500 italic">Compliance Protocol Gatekeeper (Jamaica)</p>
                </div>
                <div class="text-right">
                    <span id="protocolBadge" class="hidden px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800"></span>
                </div>
            </header>

            <form id="complianceForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Core Info -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700">Client Name</label>
                        <input type="text" id="clientName" required class="w-full p-2 border rounded mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700">TRN</label>
                        <input type="text" id="trn" placeholder="000-000-000" required class="w-full p-2 border rounded mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700">Service Objective</label>
                        <select id="sopId" onchange="applyRegistryLogic()" class="w-full p-2 border rounded mt-1 bg-white">
                            <option value="">-- Select Objective --</option>
                            <option value="SOP-001">Passport Verification (PICA)</option>
                            <option value="SOP-004">Security Clearance (JCF)</option>
                            <option value="SOP-003">Motor Insurance Check (TAJ)</option>
                            <option value="SOP-007">General Identity</option>
                        </select>
                    </div>
                    <div id="idTypeContainer">
                        <label class="block text-sm font-semibold text-slate-700">Identification Type</label>
                        <select id="idType" onchange="applyRegistryLogic()" class="w-full p-2 border rounded mt-1 bg-white">
                            <option value="Standard">Standard (Elector/Driver/Passport)</option>
                            <option value="NoID">No ID (Requires DOI)</option>
                        </select>
                    </div>
                </div>

                <!-- Protocol Gatekeeper Area -->
                <div id="protocolArea" class="bg-slate-50 p-4 rounded-lg border border-dashed border-slate-300 min-h-[180px] flex flex-col justify-center">
                    <div id="protocolPlaceholder" class="text-slate-400 text-center text-sm">
                        Select objective and ID type to reveal compliance gates...
                    </div>
                    <div id="activeGates" class="space-y-4"></div>
                </div>

                <!-- DOI Logic Area -->
                <div id="doiSection" class="hidden md:col-span-2 doi-section p-4 rounded-lg">
                    <h3 class="text-emerald-900 font-bold mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                        JP Declaration of Identity (DOI) Protocol
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-emerald-800 uppercase">Declarant Relationship</label>
                            <select id="declarantRelation" class="w-full p-2 border border-emerald-200 rounded mt-1 bg-white">
                                <option value="">-- Choose Relationship --</option>
                                <option value="Relative">Family Member</option>
                                <option value="Minister">Minister of Religion</option>
                                <option value="Principal">School Principal</option>
                                <option value="Employer">Employer (>2 Years)</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <label class="flex items-center space-x-2 text-sm text-emerald-900 font-medium">
                                <input type="checkbox" id="jpStamping" class="w-4 h-4 rounded text-emerald-600">
                                <span>I confirm JP Stamp is visible on DOI form</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 space-y-2" id="fileUploadSection">
                    <label id="uploadLabel" class="block text-sm font-semibold text-slate-700">Upload KYC Document</label>
                    <input type="file" id="kycFile" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div class="md:col-span-2 pt-4">
                    <button type="button" onclick="handleSubmission()" id="submitBtn" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition shadow-md">
                        Execute Submission
                    </button>
                </div>
            </form>
        </div>

        <!-- Audit Master Dashboard -->
        <div id="dashboard" class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold">Audit Master Dashboard</h2>
                <div class="flex space-x-2">
                    <span class="text-[10px] bg-amber-500 px-2 py-1 rounded text-black font-bold">GHOST</span>
                    <span class="text-[10px] bg-red-600 px-2 py-1 rounded text-white font-bold">MISMATCH</span>
                    <button onclick="loadDashboard()" class="ml-4 text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded">Refresh Logs</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 text-slate-600 uppercase font-semibold">
                        <tr>
                            <th class="px-6 py-3">Client Name</th>
                            <th class="px-6 py-3">Agency SOP</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">Verification Date</th>
                            <th class="px-6 py-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardBody" class="divide-y divide-slate-100">
                        <!-- Dynamic Rows will appear here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Certificate of Registry Modal -->
    <div id="certModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-1 rounded-sm max-w-2xl w-full shadow-2xl relative overflow-hidden">
            <div class="watermark uppercase">Registry Official</div>
            
            <div class="cert-border p-8 text-center bg-white m-1">
                <div class="flex justify-center mb-4">
                    <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center text-white font-bold text-xl">JAM</div>
                </div>
                
                <h2 class="text-3xl font-serif font-bold text-slate-900 uppercase tracking-widest mb-2">Certificate of Registry</h2>
                <p class="text-slate-600 italic mb-8">Verification of Data Compliance & Secure Erasure Record</p>
                
                <div class="space-y-6 text-left border-y border-slate-200 py-6 my-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-xs uppercase text-slate-400 font-bold block">Subject of Registry</span>
                            <span id="certClient" class="text-lg font-bold text-slate-800 uppercase tracking-tight">--</span>
                        </div>
                        <div>
                            <span class="text-xs uppercase text-slate-400 font-bold block">Protocol Authority</span>
                            <span id="certSop" class="text-lg font-bold text-slate-800">--</span>
                        </div>
                    </div>
                    <div>
                        <span class="text-xs uppercase text-slate-400 font-bold block">Registry Declaration</span>
                        <p class="text-sm text-slate-700 leading-relaxed">
                            Pursuant to the laws of Jamaica and the Docu-Hub Governance Framework, this document certifies that the aforementioned client has completed the mandatory identification gates. All temporary compliance tokens are scheduled for secure erasure in accordance with local Data Protection Acts.
                        </p>
                    </div>
                    <div class="flex justify-between items-end">
                        <div>
                            <span class="text-xs uppercase text-slate-400 font-bold block">Filing Timestamp</span>
                            <span id="certDate" class="text-xs font-mono text-slate-800">--</span>
                        </div>
                        <div class="text-right">
                            <div class="border-b border-slate-800 w-48 mb-1"></div>
                            <span class="text-[10px] uppercase font-bold text-slate-500">Registry Seal & Signature</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center space-x-4">
                    <button onclick="window.print()" class="px-6 py-2 bg-slate-800 text-white rounded text-sm font-bold hover:bg-slate-700">Print Record</button>
                    <button onclick="closeCert()" class="px-6 py-2 bg-slate-100 text-slate-600 rounded text-sm font-bold hover:bg-slate-200">Close Registry</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SERVICES_CONFIG = {
            "SOP-001": { name: "PICA Passport", gates: ["I confirm passport is undamaged"] },
            "SOP-004": { name: "JCF Security", gates: [], blockVoterId: true, warning: "Voter ID NOT accepted for JCF clearances." },
            "SOP-003": { name: "TAJ Insurance", gates: ["Insurance must have >30 days remaining"], dateValidation: true },
            "SOP-007": { name: "General ID", gates: ["Ghost Rescue Active"], isGhostCapable: true }
        };

        function applyRegistryLogic() {
            const sopId = document.getElementById('sopId').value;
            const idType = document.getElementById('idType').value;
            const gateContainer = document.getElementById('activeGates');
            const placeholder = document.getElementById('protocolPlaceholder');
            const doiSection = document.getElementById('doiSection');
            const badge = document.getElementById('protocolBadge');
            const uploadLabel = document.getElementById('uploadLabel');
            
            gateContainer.innerHTML = '';
            placeholder.classList.remove('hidden');

            if (idType === "NoID") {
                doiSection.classList.remove('hidden');
                uploadLabel.innerText = "Upload JP Signed Declaration (DOI)";
            } else {
                doiSection.classList.add('hidden');
                uploadLabel.innerText = "Upload KYC Document";
            }

            if (sopId && SERVICES_CONFIG[sopId]) {
                placeholder.classList.add('hidden');
                const config = SERVICES_CONFIG[sopId];
                badge.innerText = config.name;
                badge.classList.remove('hidden');

                if (config.blockVoterId) {
                    const block = document.createElement('div');
                    block.className = 'warning-red p-3 rounded text-xs font-bold';
                    block.innerText = config.warning;
                    gateContainer.appendChild(block);
                }

                config.gates.forEach((gateText, idx) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2 bg-white p-2 rounded border text-sm';
                    div.innerHTML = `<input type="checkbox" id="gate_${idx}" class="w-4 h-4"><span>${gateText}</span>`;
                    gateContainer.appendChild(div);
                });

                if (config.dateValidation) {
                    const dateDiv = document.createElement('div');
                    dateDiv.innerHTML = `<label class="block text-xs font-bold text-slate-500 uppercase">Expiry Date</label><input type="date" id="expiryDate" class="w-full p-2 border rounded mt-1">`;
                    gateContainer.appendChild(dateDiv);
                }
            } else {
                badge.classList.add('hidden');
            }
        }

        async function handleSubmission() {
            const submitBtn = document.getElementById('submitBtn');
            const payload = {
                clientName: document.getElementById('clientName').value,
                trn: document.getElementById('trn').value,
                sopId: document.getElementById('sopId').value,
                isGhost: (document.getElementById('idType').value === "NoID"),
                status: (document.getElementById('idType').value === "NoID") ? "Ghost" : "Verified"
            };

            if (!payload.clientName || !payload.sopId) return alert("Missing required info.");

            submitBtn.innerText = "Processing Sync...";
            submitBtn.disabled = true;

            if (typeof google !== 'undefined') {
                google.script.run
                    .withSuccessHandler(() => {
                        submitBtn.innerText = "Execute Submission";
                        submitBtn.disabled = false;
                        document.getElementById('complianceForm').reset();
                        applyRegistryLogic();
                        loadDashboard();
                    })
                    .submitData(payload);
            } else {
                console.log("Offline Dev Mode:", payload);
                submitBtn.innerText = "Execute Submission";
                submitBtn.disabled = false;
            }
        }

        function loadDashboard() {
            if (typeof google === 'undefined') return;
            google.script.run.withSuccessHandler(data => {
                const tbody = document.getElementById('dashboardBody');
                tbody.innerHTML = '';
                
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    const client = row[1];
                    const sop = row[3];
                    const status = row[4];
                    const timestamp = new Date(row[0]).toLocaleString();
                    
                    // Highlighting Logic
                    if (status === 'Ghost') tr.className = 'research-gold';
                    if (status === 'Mismatch') tr.className = 'warning-red';
                    
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-bold tracking-tight uppercase">${client}</td>
                        <td class="px-6 py-4">${sop}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-[10px] uppercase font-black bg-white/50 border border-black/10">
                                ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-xs font-mono">${timestamp}</td>
                        <td class="px-6 py-4">
                            <button onclick="viewCertificate('${client}', '${sop}', '${timestamp}')" class="bg-slate-800 text-white px-3 py-1 rounded text-xs hover:bg-black transition">
                                Verify Erasure
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }).getAuditLogs();
        }

        function viewCertificate(client, sop, date) {
            document.getElementById('certClient').innerText = client;
            document.getElementById('certSop').innerText = sop;
            document.getElementById('certDate').innerText = date;
            document.getElementById('certModal').classList.remove('hidden');
        }

        function closeCert() {
            document.getElementById('certModal').classList.add('hidden');
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>
